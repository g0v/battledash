function import$(e,n){var t={}.hasOwnProperty;for(var o in n)t.call(n,o)&&(e[o]=n[o]);return e}var slice$=[].slice;ldc.register("auth",["ldcvmgr","loader","util","error"],function(e){var n,t,o,i,r,a,u,l,c,s,d,f,h,g,m,p;return n=e.ldcvmgr,t=e.loader,o=e.util,i=e.error,r=function(){return u.global?JSON.parse(JSON.stringify(u.global)):null},a=[{},{}],u=a[0],l=a[1],(c={dom:ld$.find(document,"[ld-scope=cookie-consent]",0),val:o.cookie("legal"),clear:function(){if(this.dom)return ld$.remove(this.dom),this.dom=null},check:function(){var e=this;return m.get().then(function(n){var t;return((t=n.user).config||(t.config={})).legal&&e.dom?e.clear():(e.val=o.cookie("legal"))&&!(t.config||(t.config={})).legal&&t.key?ld$.fetch("/d/me/legal",{method:"POST"}).then(function(){return(t.config||(t.config={})).legal=e.val}).catch(function(){}):void 0})},init:function(){var e=this;if(!this.val&&this.dom)return this.dom.classList.remove("d-none"),ld$.find(this.dom,"[ld=ok]",0).addEventListener("click",function(){return o.cookie("legal",(new Date).getTime(),new Date(Date.now()+31536e8).toGMTString()),e.clear(),e.check()})}}).init(),ld$.find(document,".authpanel",0)&&(s=new ldForm({names:function(){return["email","passwd","displayname"]},afterCheck:function(e,n){return 1===e.email||/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.[a-z]{2,}|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i.exec(n.email.value)||(e.email=2),1!==e.passwd&&("signup"===m.act&&(n.passwd.value+"").length<8?e.passwd=2:e.passwd=n.passwd.value?0:1),"login"===m.act?e.displayname=0:e.displayname=n.displayname.value?n.displayname.value?0:2:1},root:".authpanel"}),l.submit=ld$.find(document,".authpanel .btn[data-action=submit]",0),d=new ldLoader({root:l.submit}),s.on("readystatechange",function(e){return l.submit.classList.toggle("disabled",!e)}),s.field("passwd").addEventListener("keyup",function(e){if(13===e.keyCode)return s.check({now:!0}).then(function(){return f()})}),l.submit.addEventListener("click",function(){return f()}),f=function(){var e,n,t,o;if(s.ready())return d.on(),e=s.values(),o={},o.email=e.email,o.passwd=e.passwd,o.displayname=e.displayname,t=o,t.config={newsletter:e.newsletter},n=t,ld$.fetch("login"===m.act?"/u/login":"/u/signup",{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json; charset=UTF-8"}},{type:"text"}).then(function(){return m.fetch()}).then(function(){return m.get()}).then(function(e){return p.info("default"),e.user&&lda.auth.hide("ok"),s.reset(),d.off(),m.fire("auth.signin")}).catch(function(){return p.info("failed"),s.fields.passwd.value=null,s.check({n:"passwd",now:!0}),d.off()})}),(h=ld$.find(document,".authpanel",0))&&(ld$.find(h,"[data-action]"),h.addEventListener("click",function(e){var n;if(e&&e.target&&e.target.getAttribute)return n=e.target.getAttribute("data-action"),m.switch(n)})),g=proxise(function(){if(u.global)return Promise.resolve(u.global)}),(m={evtHandler:{},on:function(e,n){var t;return((t=this.evtHandler)[e]||(t[e]=[])).push(n)},fire:function(e){var n,t,o,i,r,a=[];for(n=slice$.call(arguments,1),t=0,i=(o=this.evtHandler[e]||[]).length;t<i;++t)r=o[t],a.push(r.apply(this,n));return a},switch:function(e){if("signup"===e||"login"===e)return h.classList.remove("signup","login"),h.classList.add(this.act=e),s.check({now:!0})},social:function(e){var t,o=this;return window.open("","social-login","height=640,width=560"),t=ld$.create({name:"div"}),document.body.appendChild(t),this.get().then(function(n){var o,i;return o=n.csrfToken,t.innerHTML='<form target="social-login" action="/u/auth/'+e+'/" method="post">\n  <input type="hidden" name="_csrf" value="'+o+'"/>\n</form>',window.socialLogin=i=proxise(function(){return ld$.find(t,"form",0).submit()}),i()}).then(function(){return o.fetch()}).then(function(e){var n;if(!(n=e.user)||!n.key)return Promise.reject(new ldError(1e3))}).then(function(){return n.isOn("authpanel")?(lda.auth.hide(),m.fire("auth.signin")):window.location.reload()}).finally(function(){return ld$.remove(t)}).catch(i({ignore:[999,1e3]}))},fb:function(){return this.social("facebook")},google:function(){return this.social("google")},logout:function(){return t.on(),ld$.fetch("/u/logout",{method:"post"},{}).then(function(){return m.fetch({renew:!0})}).then(function(){return n.toggle("logout")}).then(function(){return t.off()}).catch(function(){return n.toggle("error")})},ensure:function(e){return null==e&&(e={}),this.get((e.authed=!0,e))},get:function(e){return null==e&&(e={authed:!1}),g().then(function(n){return e.authed?(n&&(n.user||(n.user={})).key?Promise.resolve(n):lda.auth.show(e.tab,e.info)).then(function(e){return e&&(e.user||(e.user={})).key?(lda.auth.hide(),e):Promise.reject(new ldError(1e3))}):n})},userinfo:function(e){var n;return((n=e)?Promise.resolve(n):this.get().then(function(e){return e.user})).then(function(e){var n,t;return null==e&&(e={}),n=e.plan||{},t=import$({},e),t.plan=n,t.authed=e.key>0,t.isPro=!!/pro/.exec(n.slug||""),t.isBlocked=!!(e.config||(e.config={})).blocked,t})},fetch:function(e){var o,i;return null==e&&(e={renew:!0}),t.onLater(1e3),o=debounce(1e4,function(){return t.off(),n.get("connection-timeout").then(function(){return t.on(),debounce(1e4)}).then(function(){return m.fetch()})})(),i=!e.renew&&/global=/.exec(document.cookie)?document.cookie.split(";").map(function(e){return/^global=(.+)/.exec(e.trim())}).filter(function(e){return e})[0]:null,(i?Promise.resolve(JSON.parse(decodeURIComponent(i[1]))):ld$.fetch("/js/global",{},{type:"json"})).then(function(e){var i,a,l;o.cancel(),t.cancel(),((i=ld$.fetch).headers||(i.headers={}))["X-CSRF-Token"]=e.csrfToken,u.global=e,u.global.location="undefined"!=typeof ipFromTaiwan&&null!==ipFromTaiwan?ipFromTaiwan(e.ip)?"tw":"other":void 0,a=r(),g.resolve(a);try{ldc.fire("auth.change",a),c.check(),"undefined"!=typeof gtag&&null!==gtag&&(!gtag.userid&&a.user&&a.user.key&&(gtag("set",{user_id:gtag.userid=a.user.key}),gtag.inited=!1),gtag.inited||(gtag("config",gtag.code,{anonymize_ip:!0}),gtag.inited=!0))}catch(e){l=e,n.toggle("error"),console.log(l)}return a}).catch(function(e){return o.cancel(),t.cancel(),n.toggle("server-down"),console.log(e)})}}).fetch({renew:!1}),p={fb:function(){return m.social("facebook")},google:function(){return m.social("google")},logout:function(){return m.logout()},isOn:function(){return n.isOn("authpanel")},show:function(e,t){return null==e&&(e="signup"),null==t&&(t="default"),Promise.resolve(n.isOn("authpanel")).then(function(n){if(!n)return m.switch(e)}).then(function(){if(t)return p.info(t)}).then(function(){return n.get("authpanel")}).then(function(e){if(e)return m.fetch()})},hide:function(e){return null==e&&(e=null),n.set("authpanel",e)},info:function(e){var n,t;return null==e&&(e="default"),n=ld$.find(h,"*[data-info]"),t={},n.map(function(e){return t[e.getAttribute("data-info")]=e}),n.map(function(e){return e.classList.add("d-none")}),t[e]||(e="default"),t[e].classList.remove("d-none")}},ldc.action(p),m});